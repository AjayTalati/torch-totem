#!/usr/bin/env th

local totem = require 'totem'
local paths = require 'paths'
local lapp = require 'pl.lapp'

local args = lapp([[Run tests

Options:
]]
..totem.Tester.CLoptions..
[[

Argument:
    --folder (string default '.') Folder containing the test scripts

]])

-- Remove the --folder argument and its value from the argument table
local found = nil
for k,v in pairs(arg) do
    if v == '--folder' then
        arg[k] = nil
        arg[k+1] = nil
        found = k+1
    elseif found and k>found then
        arg[k-2] = arg[k]
        arg[k] = nil
    end
end

-- Add slash at the end of the path if not present
if not string.match(args.folder, '.*/') then
    args.folder = args.folder .. '/'
end

-- Run all the tests in the folder
local files = paths.dir(args.folder)
if files then
    local tester = totem.Tester()
    for k,v in pairs(files) do
        if string.match(v, 'test.*%.lua') then
            print(args.folder..v)
            tester:add(args.folder..v)
        end
    end

    tester:run()
end
